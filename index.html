<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ñ‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏û‡∏•‡∏±‡∏™ - ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</title>

  <link rel="manifest" href="manifest.json">

  <meta name="theme-color" content="#0056a3">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: "Prompt", sans-serif; background: #fefefe; }
    header {
      background: #0056a3;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    header img { height: 38px; }
    #map { height: 55vh; }

    .toolbar {
      display: flex;
      padding: 8px;
      background: #fffbe8;
      border-bottom: 1px solid #ddd;
      gap: 8px;
    }

    input, select, textarea, button {
      width: 100%; padding: 8px; margin-top: 4px; font-size: 16px;
    }
    button { background: #0056a3; color: white; border: none; cursor: pointer; }

    .form-container { padding: 10px; background: #fafafa; border-top: 1px solid #ddd; }
  </style>
</head>
<body>

<header>
  <img src="icons/icon-192.png">
  <span>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏û‡∏•‡∏±‡∏™ - ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</span>
</header>

<div class="toolbar">
  <input id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ üîç">
  <select id="filterType">
    <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
    <option value="‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å</option>
    <option value="‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
  </select>
</div>

<div id="map"></div>

<div class="form-container">
  <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
  <input id="shopName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
  <select id="shopType">
    <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
    <option value="‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å</option>
    <option value="‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
  </select>
  <textarea id="shopDesc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô"></textarea>
  <button id="btnLocate">üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
  <button id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
    authDomain: "suchartwork-1487382986748.firebaseapp.com",
    databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
    projectId: "suchartwork-1487382986748",
    storageBucket: "suchartwork-1487382986748.firebasestorage.app",
    messagingSenderId: "353884592527",
    appId: "1:353884592527:web:4233ac2ae7eef075eb13fa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // MAP
  const map = L.map('map').setView([16.4322, 102.8236], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let userLocation = null;

  navigator.geolocation.getCurrentPosition(pos => {
    userLocation = [pos.coords.latitude, pos.coords.longitude];
  });

  let marker = L.marker([16.4322, 102.8236], { draggable: true }).addTo(map);

  document.getElementById("btnLocate").onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      marker.setLatLng([lat, lng]);
      map.setView([lat, lng], 16);
    });
  };

  document.getElementById("btnSave").onclick = () => {
    const name = shopName.value.trim();
    const type = shopType.value;
    const desc = shopDesc.value.trim();
    const { lat, lng } = marker.getLatLng();
    if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô");

    push(ref(db, "shops"), { name, type, desc, lat, lng });
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
  };

  const colors = { "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": "red", "‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å": "blue", "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£": "green" };

  function distance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
              Math.sin(dLon/2)**2;
    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
  }

  function refreshMarkers() {
    map.eachLayer(l => { if (l instanceof L.Marker && l !== marker) map.removeLayer(l); });

    const keyword = searchBox.value.trim();
    const filter = filterType.value;

    onValue(ref(db, "shops"), snap => {
      snap.forEach(s => {
        const d = s.val();

        if (filter !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && d.type !== filter) return;
        if (keyword && !d.name.includes(keyword)) return;

        const dist = userLocation ? `(${distance(userLocation[0], userLocation[1], d.lat, d.lng)} km ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì)` : "";

        L.marker([d.lat, d.lng], { icon: L.icon({
          iconUrl: `https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=store|${colors[d.type]}`,
          iconSize: [30, 50]
        })})
        .addTo(map)
        .bindPopup(`<b>${d.name}</b><br>${d.type}<br>${d.desc}<br>${dist}`);
      });
    });
  }

  searchBox.oninput = refreshMarkers;
  filterType.onchange = refreshMarkers;
  refreshMarkers();

  // PWA
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");
</script>
</body>
</html>
